#!/usr/bin/env python3

import argparse
import logging
import sys
import time

import insta360

# Parse command line arguments
parser = argparse.ArgumentParser(description='Test Insta360 camera connection and operations')
parser.add_argument('host', nargs='?', default='192.168.42.1',
                    help='Camera IP address for WiFi connection (default: 192.168.42.1)')
parser.add_argument('-t', '--transport', choices=['wifi', 'ble'], default='wifi',
                    help='Transport method: wifi or ble (default: wifi)')
parser.add_argument('-b', '--ble-address', 
                    help='BLE device address (optional, will scan if not provided)')
args = parser.parse_args()

# Choose logging level: NOTSET, DEBUG, INFO, WARNING, ERROR
logging.basicConfig(format='%(asctime)s %(levelname)-8s %(message)s')
logging.getLogger().setLevel(logging.DEBUG)

# Callback to handle messages
def message_handler(msg):
    print(f"Received message callback: response_code={msg.get('response_code')}, message_code={msg.get('message_code')}")

# Create camera instance with appropriate transport
if args.transport == 'wifi':
    print(f'Connecting via WiFi to {args.host}:6666')
    cam = insta360.camera(host=args.host, port=6666, transport='wifi', callback=message_handler)
else:
    print(f'Connecting via BLE' + (f' to {args.ble_address}' if args.ble_address else ' (scanning for device)'))
    cam = insta360.camera(transport='ble', device_address=args.ble_address, callback=message_handler)
    
cam.Open()

# Give BLE time to connect if needed
if args.transport == 'ble':
    print('Waiting for BLE connection to establish...')
    time.sleep(3)

# Check if connected
if not cam.is_connected:
    print('ERROR: Failed to connect to camera')
    sys.exit(1)

print(f'Successfully connected via {args.transport.upper()}')

seq = cam.SyncLocalTimeToCamera()
print('Sent packet SyncLocalTimeToCamera(): seq: %d' % (seq,))
time.sleep(1)

seq = cam.GetCameraInfo()
print('Sent packet GetCameraInfo(): seq: %d' % (seq,))
time.sleep(1)

seq = cam.GetNormalVideoOptions()
print('Sent packet GetNormalVideoOptions(): seq: %d' % (seq,))
time.sleep(1)

seq = cam.SetNormalVideoOptions()
print('Sent packet SetNormalVideoOptions(): seq: %d' % (seq,))
time.sleep(1)

seq = cam.StartCapture()
print('Sent packet StartCapture(): seq: %d' % (seq,))
time.sleep(20)
seq = cam.StopCapture()
print('Sent packet StopCapture(): seq: %d' % (seq,))
time.sleep(1)

seq = cam.TakePicture()
print('Sent packet TakePicture(): seq: %d' % (seq,))
time.sleep(1)

seq = cam.GetCameraFilesList()
print('Sent packet GetCameraFilesList(): seq: %d' % (seq,))
time.sleep(1)

# Live stream video seems to be embedded into the TCP socket data
# with header prefix '\x01\x00\x00', but the format is unknown.
#seq = cam.StartLiveStream()
#print('Sent packet StartLiveStream(): seq: %d' % (seq,))
#time.sleep(20)
#seq = cam.StopLiveStream()
#print('Sent packet StopLiveStream(): seq: %d' % (seq,))
#time.sleep(1)

# Wait messages eventually into the queue.
time.sleep(5)
cam.Close()
